<!DOCTYPE html>

<html>

<head>
<style>
#info {
    position: absolute;
    top: 0px;
    width: 100%;
    padding: 10px;
    text-align: center;
    color: #ffff00
}
body {
    overflow: hidden;
}
</style>
</head>

<body> 
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="wheel.js"></script>

<script type="x-shader/x-fragment" id="fragmentShaderDepth">
    uniform sampler2D texture;
    varying vec2 vUV;

    vec4 pack_depth(const in float depth) {

        const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
        const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
        vec4 res = fract(depth * bit_shift);
        res -= res.xxyz * bit_mask;
        return res;

    }

    void main() {

        vec4 pixel = texture2D(texture, vUV);

        if (pixel.a < 0.5) discard;

        gl_FragData[0] = pack_depth(gl_FragCoord.z);

    }
</script>
<script type="x-shader/x-vertex" id="vertexShaderDepth">
    varying vec2 vUV;

    void main() {

        vUV = 1.0 * uv;

        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);

        gl_Position = projectionMatrix * mvPosition;

    }
</script>

<script>
var camera, scene, renderer, mesh, light, controls;
var keyboard = new KeyboardState();
var tank, handle, bottom, head, turret, barrel;

init();
animate();

function init() {

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
    camera.position.z = 500;
    scene.add(camera);
    
    light = new THREE.PointLight(0xffffff);
    light.position.set(100, 300, 200);
    scene.add(light);

    var gridXZ = new THREE.GridHelper(150, 15, 'red', 'white');
    //gridXZ.position.y = -75;
    scene.add(gridXZ);

    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x888888);

    controls = new THREE.OrbitControls(camera, renderer.domElement);

    document.body.appendChild(renderer.domElement);

    ////////////////////////////////////////////////////////////////////////
    
    //wheel
    wheelInit();

    //body
    var bodyGeo = new THREE.BoxGeometry (10, 5, 10);
    var bodyTex = THREE.ImageUtils.loadTexture ('images/body_tex.jpg');
    var bodyBump = THREE.ImageUtils.loadTexture ('images/body_tex_bump.jpg');
    var bodyMat = new THREE.MeshPhongMaterial ({color: 0x555555,
    	map: bodyTex
    	});
    tank = new THREE.Mesh (bodyGeo, bodyMat);

    turret = new THREE.Object3D();

    var barrelGeo = new THREE.CylinderGeometry (1, 1, 10, 32);
    var barrelMat = new THREE.MeshPhongMaterial ({color: 0x000000});
    barrel = new THREE.Mesh (barrelGeo, barrelMat);
    barrel.position.x = 5;
    barrel.rotation.z = -Math.PI/2;

    head = new THREE.Mesh(new THREE.SphereGeometry(3, 32, 32), new THREE.MeshBasicMaterial({color: 0x664c14}));

    turret.add(head, barrel);
    turret.position.y = 10;

    //bottom
    var bottomGeo = new THREE.SphereGeometry (4, 32, 32, 0, Math.PI*2, 0, Math.PI/2);
    var bottomTex ;
    var bottomMat = new THREE.MeshPhongMaterial ({color: 0x000000});
    bottom = new THREE.Mesh (bottomGeo, bottomMat);
    bottom.position.set (0, 2.5, 0);
    tank.add (bottom);

    //handle
    var handleGeo = new THREE.CylinderGeometry (2, 2, 10, 32);
    var handleMat = new THREE.MeshPhongMaterial ({color: 0x000000});
    handle = new THREE.Mesh (handleGeo, handleMat);
    handle.position.set (0, 5, 0);

    handle.rotation.order = 'YXZ';
    handle.rotation.y = -Math.PI/2;
    tank.add (handle);


    tank.add(tire, tire2, turret);
    scene.add(tank);

    //balanceCar.position.y = 20;
    
}

function animate() {
    controls.update();
    keyboard.update();

    

    requestAnimationFrame(animate);
    render();
}

function render() {
    renderer.render(scene, camera);
}

// important to add this 
// in jsfiddle!
window.focus();
</script>
</body>

</html>